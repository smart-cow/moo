// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty;

  angular.module("moo.active-workflows.controllers", ["moo.active-workflows.services", "moo.active-workflows.directives"]).controller("ActiveWorkflowsCtrl", [
    "$scope", "WorkflowSummary", function($scope, WorkflowSummary) {
      var selectedWorkflows;
      $scope.workflowSummaries = WorkflowSummary();
      selectedWorkflows = {};
      $scope.selectWorkflow = function(wflowName) {
        if (selectedWorkflows[wflowName] == null) {
          selectedWorkflows[wflowName] = false;
        }
        return selectedWorkflows[wflowName] = !selectedWorkflows[wflowName];
      };
      return $scope.isSelected = function(wflowName) {
        var _ref;
        return (_ref = selectedWorkflows[wflowName]) != null ? _ref : false;
      };
    }
  ]).controller("ActiveTypesCtrl", [
    "$scope", "$routeParams", "RunningWorkflows", function($scope, $routeParams, RunningWorkflows) {
      $scope.workflowTypes = [];
      if ($routeParams.workflowType != null) {
        $scope.workflowTypes.push($routeParams.workflowType);
      }
      $scope.runningTypes = [];
      RunningWorkflows.query(function(data) {
        var wflow;
        return $scope.runningTypes = ((function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = data.length; _i < _len; _i++) {
            wflow = data[_i];
            _results.push(wflow.key);
          }
          return _results;
        })()).m$unique();
      });
      return $scope.showType = function(type) {
        return $scope.workflowTypes.push(type);
      };
    }
  ]);

  angular.module("moo.active-workflows.services", []).factory("WorkflowSummary", [
    "$rootScope", "$q", "RunningWorkflows", "ScowPush", function($rootScope, $q, RunningWorkflows, ScowPush) {
      var convertToMap, deferred, higherPriority, nameInOtherWflow, statusPriority, updateHeadings, updateStatus, updateWorkflow, wflowsSummary;
      wflowsSummary = {
        headings: {},
        workflows: {}
      };
      updateWorkflow = function(wflowName) {
        var id;
        id = wflowName.m$rightOf(".");
        return RunningWorkflows.status(id, updateStatus);
      };
      statusPriority = ["precluded", "completed", "contingent", "planned", "notStarted", "open"];
      higherPriority = function(status1, status2) {
        var index1, index2;
        index1 = statusPriority.indexOf(status1);
        index2 = statusPriority.indexOf(status2);
        if (index1 > index2) {
          return status1;
        } else {
          return status2;
        }
      };
      convertToMap = function(statuses) {
        var st, statusesMap, _i, _len, _ref;
        statusesMap = {};
        _ref = statuses.statuses;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          st = _ref[_i];
          statusesMap[st.name] = higherPriority(st.status, statusesMap[st.name]);
        }
        return statusesMap;
      };
      nameInOtherWflow = function(name) {
        var statuses, user, wflowName, _ref;
        _ref = wflowsSummary.workflows;
        for (wflowName in _ref) {
          if (!__hasProp.call(_ref, wflowName)) continue;
          statuses = _ref[wflowName];
          for (user in statuses) {
            if (!__hasProp.call(statuses, user)) continue;
            if (user === name) {
              return true;
            }
          }
        }
        return false;
      };
      updateHeadings = function(addedNames, removedNames) {
        var addedName, heading, headingsToRemove, n, _i, _j, _len, _len1, _results;
        for (_i = 0, _len = addedNames.length; _i < _len; _i++) {
          addedName = addedNames[_i];
          wflowsSummary.headings[addedName] = true;
        }
        headingsToRemove = (function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = removedNames.length; _j < _len1; _j++) {
            n = removedNames[_j];
            if (!nameInOtherWflow(n)) {
              _results.push(nameInOtherWflow(n));
            }
          }
          return _results;
        })();
        _results = [];
        for (_j = 0, _len1 = headingsToRemove.length; _j < _len1; _j++) {
          heading = headingsToRemove[_j];
          _results.push(delete wflowsSummary.headings[heading]);
        }
        return _results;
      };
      updateStatus = function(newStatuses) {
        var addedNames, existingStatuses, name, newStatusesMap, removedNames, status, _base, _name;
        if ((_base = wflowsSummary.workflows)[_name = newStatuses.name] == null) {
          _base[_name] = {};
        }
        existingStatuses = wflowsSummary.workflows[newStatuses.name];
        newStatusesMap = convertToMap(newStatuses);
        addedNames = [];
        for (name in newStatusesMap) {
          if (!__hasProp.call(newStatusesMap, name)) continue;
          status = newStatusesMap[name];
          if (existingStatuses[name] == null) {
            addedNames.push(name);
          }
          existingStatuses[name] = status;
        }
        removedNames = [];
        for (name in existingStatuses) {
          if (!__hasProp.call(existingStatuses, name)) continue;
          if (newStatusesMap[name] == null) {
            removedNames.push(name);
            delete existingStatuses[name];
          }
        }
        return updateHeadings(addedNames, removedNames);
      };
      deferred = $q.defer();
      RunningWorkflows.query(function(wflowData) {
        var promises, s, summaries, w;
        summaries = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = wflowData.length; _i < _len; _i++) {
            w = wflowData[_i];
            _results.push(updateWorkflow(w.id));
          }
          return _results;
        })();
        promises = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = summaries.length; _i < _len; _i++) {
            s = summaries[_i];
            _results.push(s.$promise);
          }
          return _results;
        })();
        return $q.all(promises).then(function() {
          return deferred.resolve(wflowsSummary);
        });
      });
      ScowPush.subscribe("#.tasks.#", function(task) {
        return $rootScope.$apply(function() {
          return updateWorkflow(task.processInstanceId);
        });
      });
      return function(onLoad) {
        if (onLoad == null) {
          onLoad = function() {};
        }
        deferred.promise.then(onLoad);
        return wflowsSummary;
      };
    }
  ]).factory("TypeStatuses", [
    "$q", "Workflows", "RunningWorkflows", function($q, Workflows, RunningWorkflows) {
      var getStatuses, getTasks, onInstancesReceive, sortByName;
      sortByName = function(statuses) {
        return statuses.sort(function(a, b) {
          if (a.name < b.name) {
            return -1;
          }
          if (a.name > b.name) {
            return 1;
          }
          return 0;
        });
      };
      getTasks = function(statusList) {
        var st, tasks, _i, _len;
        tasks = {};
        for (_i = 0, _len = statusList.length; _i < _len; _i++) {
          st = statusList[_i];
          tasks[st.task] = st.status;
        }
        return tasks;
      };
      onInstancesReceive = function(instanceData, onComplete) {
        var idNum, idNums, instance, promises;
        idNums = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = instanceData.length; _i < _len; _i++) {
            instance = instanceData[_i];
            _results.push(instance.id.m$rightOf("."));
          }
          return _results;
        })();
        promises = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = idNums.length; _i < _len; _i++) {
            idNum = idNums[_i];
            _results.push(RunningWorkflows.status(idNum).$promise);
          }
          return _results;
        })();
        return $q.all(promises).then(function(statuses) {
          var st, _i, _len;
          sortByName(statuses);
          for (_i = 0, _len = statuses.length; _i < _len; _i++) {
            st = statuses[_i];
            st.tasks = getTasks(st.statuses);
          }
          return onComplete(statuses);
        });
      };
      getStatuses = function(type, onComplete) {
        return Workflows.instances(type, function(data) {
          return onInstancesReceive(data, onComplete);
        });
      };
      return getStatuses;
    }
  ]);

  angular.module("moo.active-workflows.directives", []).directive("mooLegend", [
    function() {
      return {
        restrict: "E",
        templateUrl: "partials/active-workflows/legend.html",
        scope: {}
      };
    }
  ]).directive("mooInstanceStatus", [
    function() {
      return {
        restrict: "E",
        template: '<moo-workflow-tree wflow-name="name" editable="false" show-fields="false" tree-id="instanceName"></moo-workflow-tree>',
        scope: {
          name: "=",
          instanceName: "=",
          statuses: "="
        },
        link: function($scope, element) {
          var taskToSelector;
          taskToSelector = function(task) {
            return ".activity-element-" + (task.replace(" ", "-"));
          };
          return $scope.$on("workflow.tree.loaded." + $scope.instanceName, function() {
            var elements, status, task, _ref, _results;
            _ref = $scope.statuses;
            _results = [];
            for (task in _ref) {
              if (!__hasProp.call(_ref, task)) continue;
              status = _ref[task];
              elements = element.find(taskToSelector(task));
              _results.push(elements.addClass("status-" + status));
            }
            return _results;
          });
        }
      };
    }
  ]).directive("mooWorkflowTreeTable", [
    "Workflows", "TypeStatuses", function(Workflows, TypeStatuses) {
      return {
        restrict: "E",
        templateUrl: "partials/active-workflows/tree-table.html",
        scope: {
          wflowName: "=",
          statuses: "="
        },
        link: function($scope, $element) {
          var getStatuses, setTableCells;
          setTableCells = function() {
            var row, st, task, _i, _len, _ref, _results;
            _ref = $element.find("tbody tr");
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              row = _ref[_i];
              task = $(row).find("td:first-child").text().trim();
              _results.push((function() {
                var _j, _len1, _ref1, _results1;
                _ref1 = $scope.statuses;
                _results1 = [];
                for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                  st = _ref1[_j];
                  _results1.push($(row).append("<td class='" + st.tasks[task] + "'></td>"));
                }
                return _results1;
              })());
            }
            return _results;
          };
          getStatuses = function() {
            return TypeStatuses($scope.wflowName, function(statuses) {
              $scope.statuses = statuses;
              setTableCells();
              return statuses;
            });
          };
          return Workflows.get($scope.wflowName, function(wflowData) {
            ACT_FACTORY.createWorkflowTreeTable(wflowData, $element.find(".tree-table"));
            return getStatuses();
          });
        }
      };
    }
  ]);

}).call(this);

//# sourceMappingURL=active-workflows.map
