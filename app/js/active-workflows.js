// Generated by CoffeeScript 1.7.1
(function() {
  var __hasProp = {}.hasOwnProperty;

  angular.module("moo.active-workflows.controllers", ["moo.active-workflows.services", "moo.active-workflows.directives"]).controller("ActiveWorkflowsCtrl", [
    "$scope", "WorkflowSummary", function($scope, WorkflowSummary) {
      var selectedWorkflows;
      $scope.workflowSummaries = WorkflowSummary();
      selectedWorkflows = {};
      $scope.selectWorkflow = function(wflowName) {
        if (selectedWorkflows[wflowName] == null) {
          selectedWorkflows[wflowName] = false;
        }
        return selectedWorkflows[wflowName] = !selectedWorkflows[wflowName];
      };
      return $scope.isSelected = function(wflowName) {
        var _ref;
        return (_ref = selectedWorkflows[wflowName]) != null ? _ref : false;
      };
    }
  ]).controller("ActiveTypesCtrl", [
    "$scope", "$routeParams", "TypeStatuses", function($scope, $routeParams, TypeStatuses) {
      $scope.wflowName = $routeParams.workflowType;
      return $scope.statuses = TypeStatuses($scope.wflowName);
    }
  ]);

  angular.module("moo.active-workflows.services", []).factory("WorkflowSummary", [
    "$rootScope", "$q", "RunningWorkflows", "ScowPush", function($rootScope, $q, RunningWorkflows, ScowPush) {
      var convertToMap, deferred, higherPriority, nameInOtherWflow, statusPriority, updateHeadings, updateStatus, updateWorkflow, wflowsSummary;
      wflowsSummary = {
        headings: {},
        workflows: {}
      };
      updateWorkflow = function(wflowName) {
        var id;
        id = wflowName.m$rightOf(".");
        return RunningWorkflows.status(id, updateStatus);
      };
      statusPriority = ["precluded", "completed", "contingent", "planned", "notStarted", "open"];
      higherPriority = function(status1, status2) {
        var index1, index2;
        index1 = statusPriority.indexOf(status1);
        index2 = statusPriority.indexOf(status2);
        if (index1 > index2) {
          return status1;
        } else {
          return status2;
        }
      };
      convertToMap = function(statuses) {
        var st, statusesMap, _i, _len, _ref;
        statusesMap = {};
        _ref = statuses.statuses;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          st = _ref[_i];
          statusesMap[st.name] = higherPriority(st.status, statusesMap[st.name]);
        }
        return statusesMap;
      };
      nameInOtherWflow = function(name) {
        var statuses, user, wflowName, _ref;
        _ref = wflowsSummary.workflows;
        for (wflowName in _ref) {
          if (!__hasProp.call(_ref, wflowName)) continue;
          statuses = _ref[wflowName];
          for (user in statuses) {
            if (!__hasProp.call(statuses, user)) continue;
            if (user === name) {
              return true;
            }
          }
        }
        return false;
      };
      updateHeadings = function(addedNames, removedNames) {
        var addedName, heading, headingsToRemove, n, _i, _j, _len, _len1, _results;
        for (_i = 0, _len = addedNames.length; _i < _len; _i++) {
          addedName = addedNames[_i];
          wflowsSummary.headings[addedName] = true;
        }
        headingsToRemove = (function() {
          var _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = removedNames.length; _j < _len1; _j++) {
            n = removedNames[_j];
            if (!nameInOtherWflow(n)) {
              _results.push(nameInOtherWflow(n));
            }
          }
          return _results;
        })();
        _results = [];
        for (_j = 0, _len1 = headingsToRemove.length; _j < _len1; _j++) {
          heading = headingsToRemove[_j];
          _results.push(delete wflowsSummary.headings[heading]);
        }
        return _results;
      };
      updateStatus = function(newStatuses) {
        var addedNames, existingStatuses, name, newStatusesMap, removedNames, status, _base, _name;
        if ((_base = wflowsSummary.workflows)[_name = newStatuses.name] == null) {
          _base[_name] = {};
        }
        existingStatuses = wflowsSummary.workflows[newStatuses.name];
        newStatusesMap = convertToMap(newStatuses);
        addedNames = [];
        for (name in newStatusesMap) {
          if (!__hasProp.call(newStatusesMap, name)) continue;
          status = newStatusesMap[name];
          if (existingStatuses[name] == null) {
            addedNames.push(name);
          }
          existingStatuses[name] = status;
        }
        removedNames = [];
        for (name in existingStatuses) {
          if (!__hasProp.call(existingStatuses, name)) continue;
          if (newStatusesMap[name] == null) {
            removedNames.push(name);
            delete existingStatuses[name];
          }
        }
        return updateHeadings(addedNames, removedNames);
      };
      deferred = $q.defer();
      RunningWorkflows.query(function(wflowData) {
        var promises, s, summaries, w;
        summaries = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = wflowData.length; _i < _len; _i++) {
            w = wflowData[_i];
            _results.push(updateWorkflow(w.id));
          }
          return _results;
        })();
        promises = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = summaries.length; _i < _len; _i++) {
            s = summaries[_i];
            _results.push(s.$promise);
          }
          return _results;
        })();
        return $q.all(promises).then(function() {
          return deferred.resolve(wflowsSummary);
        });
      });
      ScowPush.subscribe("#.tasks.#", function(task) {
        return $rootScope.$apply(function() {
          return updateWorkflow(task.processInstanceId);
        });
      });
      return function(onLoad) {
        if (onLoad == null) {
          onLoad = function() {};
        }
        deferred.promise.then(onLoad);
        return wflowsSummary;
      };
    }
  ]).factory("TypeStatuses", [
    "Workflows", "RunningWorkflows", function(Workflows, RunningWorkflows) {
      var getStatuses, onInstancesReceive, onStatusReceive;
      onStatusReceive = function(statusData, instances) {
        var s, val, _i, _len, _ref;
        val = {};
        _ref = statusData.statuses;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          s = _ref[_i];
          val[s.task] = s.status;
        }
        return instances[statusData.name] = val;
      };
      onInstancesReceive = function(instanceData, instances) {
        var idNum, instance, _i, _len, _results;
        _results = [];
        for (_i = 0, _len = instanceData.length; _i < _len; _i++) {
          instance = instanceData[_i];
          idNum = instance.id.m$rightOf(".");
          _results.push(RunningWorkflows.status(idNum, function(statusData) {
            return onStatusReceive(statusData, instances);
          }));
        }
        return _results;
      };
      getStatuses = function(type) {
        var instances;
        instances = {};
        Workflows.instances(type, function(data) {
          return onInstancesReceive(data, instances);
        });
        return instances;
      };
      return getStatuses;
    }
  ]);

  angular.module("moo.active-workflows.directives", []).directive("mooLegend", [
    function() {
      return {
        restrict: "E",
        templateUrl: "partials/active-workflows/legend.html",
        scope: {}
      };
    }
  ]).directive("mooInstanceStatus", [
    function() {
      return {
        restrict: "E",
        templateUrl: "partials/active-workflows/instance-status.html",
        scope: {
          name: "=",
          instanceName: "=",
          statuses: "="
        },
        link: function($scope, element) {
          var taskToSelector;
          taskToSelector = function(task) {
            return ".activity-element-" + (task.replace(" ", "-"));
          };
          return $scope.$on("workflow.tree.loaded." + $scope.instanceName, function() {
            var elements, status, task, _ref, _results;
            _ref = $scope.statuses;
            _results = [];
            for (task in _ref) {
              if (!__hasProp.call(_ref, task)) continue;
              status = _ref[task];
              elements = element.find(taskToSelector(task));
              _results.push(elements.addClass("status-" + status));
            }
            return _results;
          });
        }
      };
    }
  ]);

}).call(this);

//# sourceMappingURL=active-workflows.map
